@Component
script MonsterCodexBanner extends Component

	property Entity messageLabel = nil

	property Entity iconImage = nil

	property number showDuration = 3

	property number slideSpeed = 500

	property number originalY = 0

	property number hiddenY = 100

	property integer slideInTimer = 0

	property integer slideOutTimer = 0

	property integer waitTimer = 0

	property integer animationId = 0

	@ExecSpace("ClientOnly")
	method void OnBeginPlay()
		if self.messageLabel == nil then
			self.messageLabel = self.Entity:GetChildByName("MessageLabel")
		end
		if self.iconImage == nil then
			self.iconImage = self.Entity:GetChildByName("IconImage")
		end

		-- 원래 위치 저장
		self.originalY = self.Entity.UITransformComponent.Position.y
		self.hiddenY = self.originalY + 150

		-- 초기에는 숨김
		self.Entity.Enable = false
		self.Entity.Visible = false
	end

	method void CancelAllTimers()
		-- 모든 진행 중인 타이머 취소
		if self.slideInTimer ~= 0 then
			_TimerService:ClearTimer(self.slideInTimer)
			self.slideInTimer = 0
		end
		if self.slideOutTimer ~= 0 then
			_TimerService:ClearTimer(self.slideOutTimer)
			self.slideOutTimer = 0
		end
		if self.waitTimer ~= 0 then
			_TimerService:ClearTimer(self.waitTimer)
			self.waitTimer = 0
		end
	end

	method void Show(string monsterName, string monsterId)
		-- 새로운 애니메이션 ID 생성 (기존 애니메이션 무효화)
		self.animationId = self.animationId + 1
		local currentAnimId = self.animationId

		-- 기존 애니메이션 취소
		self:CancelAllTimers()

		if self.messageLabel ~= nil then
			self.messageLabel.TextComponent.Text = monsterName .. " 도감 등록 완료!\n로비 내 도감에서 보상을 수령하세요!"
		end

		-- 유닛 이미지 설정
		if self.iconImage ~= nil then
			local unitInfo = _UnitService:GetUnitByIDFromClient(monsterId)
			if unitInfo ~= nil and unitInfo["ImageRUID"] ~= nil and unitInfo["ImageRUID"] ~= "" then
				self.iconImage.SpriteGUIRendererComponent.ImageRUID = unitInfo["ImageRUID"]
			end
		end

		-- 시작 위치 (화면 밖)
		local pos = self.Entity.UITransformComponent.Position
		self.Entity.UITransformComponent.Position = Vector3(pos.x, self.hiddenY, pos.z)

		self.Entity.Enable = true
		self.Entity.Visible = true

		-- 슬라이드 인
		self:SlideIn(currentAnimId)
	end

	method void SlideIn(integer animId)
		local startY = self.hiddenY
		local endY = self.originalY
		local duration = 0.3

		local elapsed = 0
		local tick = 1/60

		self.slideInTimer = _TimerService:SetTimerRepeat(function(dt)
			-- 애니메이션 ID가 바뀌었으면 종료
			if self.animationId ~= animId then
				return false
			end

			elapsed = elapsed + tick

			local progress = math.min(elapsed / duration, 1)
			-- 이징 함수 (ease out)
			local easeProgress = 1 - math.pow(1 - progress, 3)

			local currentY = startY + (endY - startY) * easeProgress
			local pos = self.Entity.UITransformComponent.Position
			self.Entity.UITransformComponent.Position = Vector3(pos.x, currentY, pos.z)

			if progress >= 1 then
				self.slideInTimer = 0
				-- 일정 시간 후 슬라이드 아웃
				self.waitTimer = _TimerService:SetTimerOnce(function()
					-- 애니메이션 ID가 바뀌었으면 무시
					if self.animationId ~= animId then
						return
					end
					self.waitTimer = 0
					self:SlideOut(animId)
				end, self.showDuration)
				return false
			end

			return true
		end, tick)
	end

	method void SlideOut(integer animId)
		local startY = self.originalY
		local endY = self.hiddenY
		local duration = 0.3

		local elapsed = 0
		local tick = 1/60

		self.slideOutTimer = _TimerService:SetTimerRepeat(function(dt)
			-- 애니메이션 ID가 바뀌었으면 종료
			if self.animationId ~= animId then
				return false
			end

			elapsed = elapsed + tick

			local progress = math.min(elapsed / duration, 1)
			-- 이징 함수 (ease in)
			local easeProgress = math.pow(progress, 3)

			local currentY = startY + (endY - startY) * easeProgress
			local pos = self.Entity.UITransformComponent.Position
			self.Entity.UITransformComponent.Position = Vector3(pos.x, currentY, pos.z)

			if progress >= 1 then
				self.slideOutTimer = 0
				self.Entity.Enable = false
				self.Entity.Visible = false
				return false
			end

			return true
		end, tick)
	end

end
